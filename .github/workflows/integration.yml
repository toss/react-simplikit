name: Integration

on:
  pull_request:
    branches:
      - develop

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Run linter
        run: |
          corepack enable
          yarn install
          yarn run lint

  check-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.filter.outputs.changed }}
      changed_files: ${{ steps.filter.outputs.changed_files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Check for changes in .ts and .tsx files
        id: filter
        uses: dorny/paths-filter@v3
        with:
          list-files: shell
          filters: |
            changed:
              - 'src/components/**/*.ts'
              - 'src/components/**/*.tsx'
              - 'src/hooks/**/*.ts'
              - 'src/hooks/**/*.tsx'
              - 'src/utils/**/*.ts'
              - 'src/utils/**/*.tsx'

  verify-documentation:
    runs-on: ubuntu-latest
    needs: check-changes
    if: ${{ needs.check-changes.outputs.changed == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify documentation exists
        run: |
          for file in ${{ needs.check-changes.outputs.changed_files }}; do
            dir_name=$(basename $(dirname "$file"))
            base_name=$(basename $dir_name)

            doc_file="$(dirname "$file")/$base_name.md"
            
            if [ ! -f "$doc_file" ]; then
              echo "Documentation missing for $base_name"
              exit 1
            fi
          done

  verify-test:
    runs-on: ubuntu-latest
    needs: check-changes
    if: ${{ needs.check-changes.outputs.changed == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Verify and run tests with coverage
        run: |
          corepack enable
          yarn install

          for file in ${{ needs.check-changes.outputs.changed_files }}; do
            dir_name=$(basename $(dirname "$file"))
            base_name=$(basename $dir_name)

            test_file="$(dirname "$file")/$base_name.spec.ts"

            if [ ! -f "$test_file" ]; then
              test_file="$(dirname "$file")/$base_name.spec.tsx"

              if [ ! -f "$test_file" ]; then
                echo "Test file missing for $base_name"
                exit 1
              fi
            fi
          done

  verify-jsdoc:
    runs-on: ubuntu-latest
    needs: check-changes
    if: ${{ needs.check-changes.outputs.changed == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for JSDoc comments
        run: |
          for file in ${{ needs.check-changes.outputs.changed_files }}; do
            dir_name=$(basename $(dirname "$file"))
            base_name=$(basename $dir_name)
            implementation="$(dirname "$file")/$base_name.ts"

            if [ ! -f "$implementation" ]; then
              implementation="$(dirname "$file")/$base_name.tsx"

              if [ ! -f "$implementation" ]; then
                echo "Implementation missing for $file"
                exit 1
              fi
            fi

            if ! grep -q "/\*\*" "$implementation"; then
              echo "JSDoc comments missing in $implementation"
              exit 1
            fi

            if ! grep -q "@description" "$implementation"; then
              echo "@description tag missing in $implementation"
              exit 1
            fi

            if ! grep -q "@example" "$implementation"; then
              echo "@example tag missing in $implementation"
              exit 1
            fi
          done
